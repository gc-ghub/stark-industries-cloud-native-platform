##############################################
#Triggers on push to feature/**. 
#Spins up a temporary Kind cluster using an action, deploys Helm chart into it for quick dev validation.
##############################################


name: Dev — Feature → Kind

on:
  push:
    branches:
      - "feature/**"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build local Docker image
        run: |
          docker build -t stark-dev:${{ github.sha }} ./go-app

      - name: Set up kind cluster
        uses: engineerd/setup-kind@v0.6.0
        with:
          version: v0.20.0

      - name: Load image into kind
        run: |
          kind load docker-image stark-dev:${{ github.sha }}

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3

      - name: Deploy Helm chart to Kind (dev)
        run: |
          kubectl create ns dev || true
          helm upgrade --install stark-dev ./helm/stark-industries-go \
            --namespace dev \
            --set image.repository=stark-dev \
            --set image.tag=${{ github.sha }} \
            --wait

      - name: Smoke test
        run: |
          kubectl -n dev rollout status deploy/stark-dev-stark-industries-go --timeout=120s || true
